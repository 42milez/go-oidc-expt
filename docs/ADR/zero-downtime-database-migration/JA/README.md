# ADR: Zero Downtime Database Migration

この決定は `go-oidc-server` がデータベース移行を無停止で行う方法について定義する。

## Status

Proposal

## Date

2024-01-01

## Context

`go-oidc-server` は OpenID Connect に準拠した認証・認可の仕組みを提供する。`go-oidc-server` が停止することは、これに依存するクライアント（ Relying Party ）の可用性を損なうことになる。そのため `go-oidc-server` は 24 時間 365 日稼働し続けられることが望ましい。

`go-oidc-server` が停止する状況としては次のものが考えられる。

1. `go-oidc-server` の不具合
2. インフラストラクチャーの障害
3. メンテナンス作業

特に「3. メンテナンス作業」において `go-oidc-server` の停止を伴うと想定されるものに「データベース移行」（ e.g. 新しいデータベースエンジンへのアップグレード ）がある。ダウンタイムを伴わない形で移行作業を実施できれば、クライアントは本作業に起因して可用性を損なうことはない。

上述の理由により `go-oidc-server` にはデータベース移行を無停止で実施するための機能が必須であると考える。

## Decision

データベース移行を無停止で実施するため、`go-oidc-server` にデータベース移行モード（以下「移行モード」と称する）を追加する。移行モードでは現行データベースに加えて移行先データベースが読み書きの対象となる。

### データベース移行の流れ

データベース移行は次に示す 4 つのステップを経て完了する。

1. データ複製
2. 二重書き込み / 差分同期
3. 読み込み元データベースの切り替え
4. 書き込み先データベースの切り替え

#### 1. データ複製

ある時点の現行データベースの状態から移行先データベースを作成する。移行するデータを極力少なくすることを目的として本手続きを踏む。

#### 2. 二重書き込み / 差分同期

##### 二重書き込み

`go-oidc-server` は現行データベースへの書き込みと並行して移行先データベースにも書き込みを行う。これは現行・移行先データベース間に差分が発生することを防ぐことを目的としている。二重書き込みは次の規則に従って行われる。

- データは現行データベースに書き込まれた後、移行先データベースに書き込まれる
  - 現行データベースへの書き込みに失敗した場合、移行先データベースへの書き込みは行わない
  - 移行先データベースへの書き込みに失敗した場合、後述の「差分同期」によって再度移行先データベースへの書き込みが行われる

なお、この時点では二重書き込みを開始する前に発生した差分が依然として存在している。この差分を解消するために「差分同期」を行う。

##### 差分同期

| 用語       | 意味                |
|----------|-------------------|
| データセグメント | テーブル内の連続したレコードの集合 |

差分同期は `go-oidc-server` とは異なる環境で実行されるプロセス（以下「差分同期サービス」と称する）が行う。差分同期サービスは現行データベースから移行先データベースへ差分を同期する（逆方向の同期は行わない）。同期は次の規則に従って行われる。

- 複数の Goroutine が並行してデータを同期する
- 1 つの Goroutine は 1 つのデータセグメントをロックできる（この場合のロックはアプリケーションレベルのロックを意味する）
  - Goroutine がロックを解放するまで別の Goroutine は当該データセグメントのロックを取得できない（排他制御）
- `go-oidc-server` へのパフォーマンス影響を考慮して、差分同期の際にデータベースエンジン側でのロック操作は行わない

#### 3. 読み込み元データベースの切り替え

`go-oidc-server` のデータ読み込み元を現行データベースから移行先データベースに切り替える。なお、二重書き込みは引き続き実施しておき、現行データベースへ切り戻せる状況を維持する。

#### 4. 書き込み先データベースの切り替え

二重書き込みを停止して、書き込み先を移行先データベースのみとする。

## Consequences

### Positive

...

### Negative

...

## Notes

- Author: [42milez](https://github.com/42milez)
- Revision: 1
- Changelog
  - 1: 初回提案
