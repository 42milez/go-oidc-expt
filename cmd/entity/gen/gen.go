//go:build ignore

package main

import (
	"bytes"
	"fmt"
	"go/format"
	"html/template"
	"log"
	"os"
	"reflect"
	"regexp"
	"strings"
	"unicode"

	"github.com/42milez/go-oidc-server/pkg/ent/ent"

	"github.com/Masterminds/sprig"
)

const templateFile = "entity.gotmpl"

type entField struct {
	Name string
	Type string
}

type entParam struct {
	SchemaName string
	Fields     []*entField
}

func shortenByCapitalLetter(s string) string {
	var v []rune
	for _, r := range s {
		if unicode.IsUpper(r) {
			v = append(v, r)
		}
	}
	return strings.ToLower(string(v))
}

func isEdgeField(f string) bool {
	re, err := regexp.Compile(`^Edges$`)
	if err != nil {
		log.Fatal(err)
	}
	return re.MatchString(f)
}

func isPrivateField(f string) bool {
	re, err := regexp.Compile(`^[a-z]`)
	if err != nil {
		log.Fatal(err)
	}
	return re.MatchString(f)
}

func main() {
	targets := []any{
		ent.AuthCode{},
		ent.Consent{},
		ent.RedirectURI{},
		ent.RelyingParty{},
		ent.User{},
	}

	funcMap := template.FuncMap{
		"isEdgeField":            isEdgeField,
		"isPrivateField":         isPrivateField,
		"shortenByCapitalLetter": shortenByCapitalLetter,
	}

	for _, v := range targets {
		tgt := reflect.TypeOf(v)

		param := &entParam{
			SchemaName: tgt.Name(),
		}

		for i := 0; i < tgt.NumField(); i++ {
			param.Fields = append(param.Fields, &entField{
				Name: tgt.Field(i).Name,
				Type: tgt.Field(i).Type.String(),
			})
		}

		var buf bytes.Buffer
		t := template.Must(template.New(templateFile).Funcs(funcMap).Funcs(sprig.FuncMap()).
			ParseFiles(fmt.Sprintf("gen/templates/%s", templateFile)))
		if err := t.Execute(&buf, param); err != nil {
			log.Fatal(err)
		}

		var out bytes.Buffer
		out.WriteString(fmt.Sprintf("// Code generated by cmd/entity/gen/gen.go; DO NOT EDIT.\npackage entity\n"))
		out.Write(buf.Bytes())

		body, err := format.Source(out.Bytes())
		if err != nil {
			log.Fatal(err)
		}

		var output = fmt.Sprintf("%s_gen.go", strings.ToLower(tgt.Name()))

		if err = os.WriteFile(output, body, 0644); err != nil {
			log.Fatal(err)
		}
	}
}
