name: CI
on:
  push:
    paths-ignore:
      - "**.md"
      - "LICENSE"
jobs:
  analyze:
    strategy:
      matrix:
        os:
          - ubuntu-latest
        go-version:
          - 1.21.0
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}
          cache: false
          check-latest: false
      - name: Restore caches
        id: restore-cache
        uses: actions/cache/restore@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg
          key: ${{ github.job }}-go${{ matrix.go-version }}-${{ github.ref_name }}-${{ hashFiles('go.sum') }}
      - name: Generate secrets
        run: |
          ./script/bootstrap/key.sh
          ./script/bootstrap/keypair.sh
      - uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          skip-pkg-cache: true
          skip-build-cache: true
      - name: Save caches
        if: steps.restore-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg
          key: ${{ github.job }}-go${{ matrix.go-version }}-${{ github.ref_name }}-${{ hashFiles('go.sum') }}
  build:
    needs: analyze
    strategy:
      matrix:
        os:
          - ubuntu-latest
        go-version:
          - 1.21.0
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/app/Dockerfile
          push: true
          tags: 42milez/go-oidc-server-app-integ-test:latest
          cache-from: type=registry,ref=42milez/go-oidc-server-app-integ-test:buildcache
          cache-to: type=registry,ref=42milez/go-oidc-server-app-integ-test:buildcache,mode=max
  test:
    needs:
      - analyze
      - build
    strategy:
      matrix:
        os:
          - ubuntu-latest
        go-version:
          - 1.21.0
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}
          cache: false
          check-latest: false
      - name: Restore caches
        id: restore-cache
        uses: actions/cache/restore@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg
          key: ${{ github.job }}-go${{ matrix.go-version }}-${{ github.ref_name }}-${{ hashFiles('go.sum') }}
      - name: Generate secrets
        run: |
          ./script/bootstrap/key.sh
          ./script/bootstrap/keypair.sh
      - name: Install atlas
        run: curl -sSf https://atlasgo.sh | sh
      - name: Start services
        run: docker-compose up -d app-integ-test cache db
      - name: Wait for database to be available
        run: .github/scripts/waiter/db.sh
      - name: Apply migrations
        run: make migrate-apply DB_NAMES=idp_integ_test
      - name: Run all tests
        run: make test
      - name: Save caches
        if: steps.restore-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg
          key: ${{ github.job }}-go${{ matrix.go-version }}-${{ github.ref_name }}-${{ hashFiles('go.sum') }}
  notify:
    if: always()
    needs: [ analyze, test ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Post CI status to Slack
        run: |
          .github/scripts/notifier/post-ci-status-to-slack.sh
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          TEST_RESULT: ${{ needs.test.result }}
          SLACK_BOT_USER_OAUTH_TOKEN: ${{ secrets.SLACK_BOT_USER_OAUTH_TOKEN }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
          SLACK_USERNAME: ${{ secrets.SLACK_USERNAME }}
